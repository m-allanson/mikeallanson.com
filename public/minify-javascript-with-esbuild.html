<!DOCTYPE html>
<script>
window.componentPath = "/minify-javascript-with-esbuild.js";
window.wrapperComponentPath = "/src/page-wrapper.js";
window.dataPath = "/minify-javascript-with-esbuild.json";
</script>
<html lang="en">
  <head>
  <title data-react-helmet="true">Minify JavaScript with esbuild ðŸª² mikeallanson.com</title>
  <meta data-react-helmet="true" charset="utf-8"/><meta data-react-helmet="true" name="viewport" content="width=device-width, initial-scale=1"/><meta data-react-helmet="true" name="description" content="TODO!! Here is my lovely placeholder description"/>
  <link data-react-helmet="true" type="font/woff2" href="fonts/ibm-plex-serif-v9-latin-700.woff2" rel="preload" as="font" crossorigin="anonymous"/><link data-react-helmet="true" rel="stylesheet" href="/styles.css"/><link data-react-helmet="true" rel="icon" href="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text y=%22.9em%22 font-size=%2290%22&gt;ðŸª²&lt;/text&gt;&lt;/svg&gt;"/><link data-react-helmet="true" rel="alternate icon" href="/favicon.ico"/>
  
  
  </head>
  <body >
    <div id="toast-page-section"><header role="banner"><a href="/" aria-label="Mike Allanson">Mike Allanson</a></header><main><article is="post" class="flow"><h1 id="minify-javascript-with-esbuild" is="postHeading">Minify JavaScript with esbuild</h1><blockquote class="flow"><p><em>Update 2021-09-11:</em> <a href="https://github.com/evanw/esbuild/releases/tag/v0.9.0"><code>esbuild v0.9.0</code></a> removed support for the <code>startService</code> API used in this post. For <code>esbuild v0.12.26</code>, <a href="https://github.com/m-allanson/mikeallanson.com/blob/8a36ff8b3c3c21d4f478025a342dbd0e06ba4b9d/scripts/minify-js.js">this script</a> is working for me.</p></blockquote><p><a href="https://esbuild.github.io/">esbuild's website</a> says it's:</p><blockquote class="flow"><p>An extremely fast JavaScript bundler</p></blockquote><p>I want to minify some code without worrying about bundling. esbuild can do that too.</p><p>Some <a href="https://github.com/privatenumber/minification-benchmarks">recent minification benchmarks</a> mark it significantly faster than most other bundlers, and within a few percent on output filesize.</p><p>Sounds good to me!</p><p>Here's how I'm using it:</p><div is="code" codestring="import esbuild from \&quot;esbuild\&quot;;\nimport fs from \&quot;fs/promises\&quot;;\n\nasync function* getFiles(path = `./`) {\n  const entries = await fs.readdir(path, { withFileTypes: true });\n\n  for (let file of entries) {\n    if (file.isDirectory()) {\n      yield* getFiles(`${path}${file.name}/`);\n    } else {\n      yield path + file.name;\n    }\n  }\n}\n\nasync function main(dir) {\n  const options = {\n    format: \&quot;esm\&quot;,\n    minify: true,\n    target: \&quot;es2020\&quot;,\n  };\n\n  try {\n    for await (const filePath of getFiles(dir)) {\n      if (filePath.endsWith(\&quot;.js\&quot;)) {\n        const fileContents = await fs.readFile(filePath, \&quot;utf-8\&quot;);\n        const transformed = await service.transform(fileContents, options);\n        await fs.writeFile(filePath, transformed.code);\n      }\n    }\n  } finally {\n    service.stop();\n  }\n}\n\nawait main(\&quot;public/\&quot;);" class="language-js"><pre style="color: #d6deeb; background-color: transparent;" class="prism-code language-js"><div style="color: #d6deeb;" class="token-line"><span style="color: rgb(127, 219, 202);" class="token keyword module">import</span><span class="token plain"> </span><span class="token imports">esbuild</span><span class="token plain"> </span><span style="color: rgb(127, 219, 202);" class="token keyword module">from</span><span class="token plain"> </span><span style="color: rgb(173, 219, 103);" class="token string">&quot;esbuild&quot;</span><span style="color: rgb(199, 146, 234);" class="token punctuation">;</span><span class="token plain"></span></div><div style="color: #d6deeb;" class="token-line"><span class="token plain"></span><span style="color: rgb(127, 219, 202);" class="token keyword module">import</span><span class="token plain"> </span><span class="token imports">fs</span><span class="token plain"> </span><span style="color: rgb(127, 219, 202);" class="token keyword module">from</span><span class="token plain"> </span><span style="color: rgb(173, 219, 103);" class="token string">&quot;fs/promises&quot;</span><span style="color: rgb(199, 146, 234);" class="token punctuation">;</span><span class="token plain"></span></div><div style="color: #d6deeb;" class="token-line"><span style="display: inline-block;" class="token plain">
</span></div><div style="color: #d6deeb;" class="token-line"><span class="token plain"></span><span style="color: rgb(127, 219, 202);" class="token keyword">async</span><span class="token plain"> </span><span style="color: rgb(127, 219, 202);" class="token keyword">function</span><span style="color: rgb(127, 219, 202);" class="token operator">*</span><span class="token plain"> </span><span style="color: rgb(130, 170, 255);" class="token function">getFiles</span><span style="color: rgb(199, 146, 234);" class="token punctuation">(</span><span class="token plain">path </span><span style="color: rgb(127, 219, 202);" class="token operator">=</span><span class="token plain"> </span><span style="color: rgb(173, 219, 103);" class="token template-string template-punctuation string">`</span><span style="color: rgb(173, 219, 103);" class="token template-string string">./</span><span style="color: rgb(173, 219, 103);" class="token template-string template-punctuation string">`</span><span style="color: rgb(199, 146, 234);" class="token punctuation">)</span><span class="token plain"> </span><span style="color: rgb(199, 146, 234);" class="token punctuation">{</span><span class="token plain"></span></div><div style="color: #d6deeb;" class="token-line"><span class="token plain">  </span><span style="color: rgb(127, 219, 202);" class="token keyword">const</span><span class="token plain"> entries </span><span style="color: rgb(127, 219, 202);" class="token operator">=</span><span class="token plain"> </span><span style="color: rgb(127, 219, 202);" class="token keyword control-flow">await</span><span class="token plain"> fs</span><span style="color: rgb(199, 146, 234);" class="token punctuation">.</span><span style="color: rgb(130, 170, 255);" class="token method function property-access">readdir</span><span style="color: rgb(199, 146, 234);" class="token punctuation">(</span><span class="token plain">path</span><span style="color: rgb(199, 146, 234);" class="token punctuation">,</span><span class="token plain"> </span><span style="color: rgb(199, 146, 234);" class="token punctuation">{</span><span class="token plain"> withFileTypes</span><span style="color: rgb(127, 219, 202);" class="token operator">:</span><span class="token plain"> </span><span style="color: rgb(255, 88, 116);" class="token boolean">true</span><span class="token plain"> </span><span style="color: rgb(199, 146, 234);" class="token punctuation">}</span><span style="color: rgb(199, 146, 234);" class="token punctuation">)</span><span style="color: rgb(199, 146, 234);" class="token punctuation">;</span><span class="token plain"></span></div><div style="color: #d6deeb;" class="token-line"><span style="display: inline-block;" class="token plain">
</span></div><div style="color: #d6deeb;" class="token-line"><span class="token plain">  </span><span style="color: rgb(127, 219, 202);" class="token keyword control-flow">for</span><span class="token plain"> </span><span style="color: rgb(199, 146, 234);" class="token punctuation">(</span><span style="color: rgb(127, 219, 202);" class="token keyword">let</span><span class="token plain"> file </span><span style="color: rgb(127, 219, 202);" class="token keyword">of</span><span class="token plain"> entries</span><span style="color: rgb(199, 146, 234);" class="token punctuation">)</span><span class="token plain"> </span><span style="color: rgb(199, 146, 234);" class="token punctuation">{</span><span class="token plain"></span></div><div style="color: #d6deeb;" class="token-line"><span class="token plain">    </span><span style="color: rgb(127, 219, 202);" class="token keyword control-flow">if</span><span class="token plain"> </span><span style="color: rgb(199, 146, 234);" class="token punctuation">(</span><span class="token plain">file</span><span style="color: rgb(199, 146, 234);" class="token punctuation">.</span><span style="color: rgb(130, 170, 255);" class="token method function property-access">isDirectory</span><span style="color: rgb(199, 146, 234);" class="token punctuation">(</span><span style="color: rgb(199, 146, 234);" class="token punctuation">)</span><span style="color: rgb(199, 146, 234);" class="token punctuation">)</span><span class="token plain"> </span><span style="color: rgb(199, 146, 234);" class="token punctuation">{</span><span class="token plain"></span></div><div style="color: #d6deeb;" class="token-line"><span class="token plain">      </span><span style="color: rgb(127, 219, 202);" class="token keyword control-flow">yield</span><span style="color: rgb(127, 219, 202);" class="token operator">*</span><span class="token plain"> </span><span style="color: rgb(130, 170, 255);" class="token function">getFiles</span><span style="color: rgb(199, 146, 234);" class="token punctuation">(</span><span style="color: rgb(173, 219, 103);" class="token template-string template-punctuation string">`</span><span style="color: rgb(199, 146, 234);" class="token template-string interpolation interpolation-punctuation punctuation">${</span><span class="token template-string interpolation">path</span><span style="color: rgb(199, 146, 234);" class="token template-string interpolation interpolation-punctuation punctuation">}</span><span style="color: rgb(199, 146, 234);" class="token template-string interpolation interpolation-punctuation punctuation">${</span><span class="token template-string interpolation">file</span><span style="color: rgb(199, 146, 234);" class="token template-string interpolation punctuation">.</span><span class="token template-string interpolation property-access">name</span><span style="color: rgb(199, 146, 234);" class="token template-string interpolation interpolation-punctuation punctuation">}</span><span style="color: rgb(173, 219, 103);" class="token template-string string">/</span><span style="color: rgb(173, 219, 103);" class="token template-string template-punctuation string">`</span><span style="color: rgb(199, 146, 234);" class="token punctuation">)</span><span style="color: rgb(199, 146, 234);" class="token punctuation">;</span><span class="token plain"></span></div><div style="color: #d6deeb;" class="token-line"><span class="token plain">    </span><span style="color: rgb(199, 146, 234);" class="token punctuation">}</span><span class="token plain"> </span><span style="color: rgb(127, 219, 202);" class="token keyword control-flow">else</span><span class="token plain"> </span><span style="color: rgb(199, 146, 234);" class="token punctuation">{</span><span class="token plain"></span></div><div style="color: #d6deeb;" class="token-line"><span class="token plain">      </span><span style="color: rgb(127, 219, 202);" class="token keyword control-flow">yield</span><span class="token plain"> path </span><span style="color: rgb(127, 219, 202);" class="token operator">+</span><span class="token plain"> file</span><span style="color: rgb(199, 146, 234);" class="token punctuation">.</span><span class="token property-access">name</span><span style="color: rgb(199, 146, 234);" class="token punctuation">;</span><span class="token plain"></span></div><div style="color: #d6deeb;" class="token-line"><span class="token plain">    </span><span style="color: rgb(199, 146, 234);" class="token punctuation">}</span><span class="token plain"></span></div><div style="color: #d6deeb;" class="token-line"><span class="token plain">  </span><span style="color: rgb(199, 146, 234);" class="token punctuation">}</span><span class="token plain"></span></div><div style="color: #d6deeb;" class="token-line"><span class="token plain"></span><span style="color: rgb(199, 146, 234);" class="token punctuation">}</span><span class="token plain"></span></div><div style="color: #d6deeb;" class="token-line"><span style="display: inline-block;" class="token plain">
</span></div><div style="color: #d6deeb;" class="token-line"><span class="token plain"></span><span style="color: rgb(127, 219, 202);" class="token keyword">async</span><span class="token plain"> </span><span style="color: rgb(127, 219, 202);" class="token keyword">function</span><span class="token plain"> </span><span style="color: rgb(130, 170, 255);" class="token function">main</span><span style="color: rgb(199, 146, 234);" class="token punctuation">(</span><span class="token parameter">dir</span><span style="color: rgb(199, 146, 234);" class="token punctuation">)</span><span class="token plain"> </span><span style="color: rgb(199, 146, 234);" class="token punctuation">{</span><span class="token plain"></span></div><div style="color: #d6deeb;" class="token-line"><span class="token plain">  </span><span style="color: rgb(127, 219, 202);" class="token keyword">const</span><span class="token plain"> options </span><span style="color: rgb(127, 219, 202);" class="token operator">=</span><span class="token plain"> </span><span style="color: rgb(199, 146, 234);" class="token punctuation">{</span><span class="token plain"></span></div><div style="color: #d6deeb;" class="token-line"><span class="token plain">    format</span><span style="color: rgb(127, 219, 202);" class="token operator">:</span><span class="token plain"> </span><span style="color: rgb(173, 219, 103);" class="token string">&quot;esm&quot;</span><span style="color: rgb(199, 146, 234);" class="token punctuation">,</span><span class="token plain"></span></div><div style="color: #d6deeb;" class="token-line"><span class="token plain">    minify</span><span style="color: rgb(127, 219, 202);" class="token operator">:</span><span class="token plain"> </span><span style="color: rgb(255, 88, 116);" class="token boolean">true</span><span style="color: rgb(199, 146, 234);" class="token punctuation">,</span><span class="token plain"></span></div><div style="color: #d6deeb;" class="token-line"><span class="token plain">    target</span><span style="color: rgb(127, 219, 202);" class="token operator">:</span><span class="token plain"> </span><span style="color: rgb(173, 219, 103);" class="token string">&quot;es2020&quot;</span><span style="color: rgb(199, 146, 234);" class="token punctuation">,</span><span class="token plain"></span></div><div style="color: #d6deeb;" class="token-line"><span class="token plain">  </span><span style="color: rgb(199, 146, 234);" class="token punctuation">}</span><span style="color: rgb(199, 146, 234);" class="token punctuation">;</span><span class="token plain"></span></div><div style="color: #d6deeb;" class="token-line"><span style="display: inline-block;" class="token plain">
</span></div><div style="color: #d6deeb;" class="token-line"><span class="token plain">  </span><span style="color: rgb(127, 219, 202);" class="token keyword control-flow">try</span><span class="token plain"> </span><span style="color: rgb(199, 146, 234);" class="token punctuation">{</span><span class="token plain"></span></div><div style="color: #d6deeb;" class="token-line"><span class="token plain">    </span><span style="color: rgb(127, 219, 202);" class="token keyword control-flow">for</span><span class="token plain"> </span><span style="color: rgb(127, 219, 202);" class="token keyword control-flow">await</span><span class="token plain"> </span><span style="color: rgb(199, 146, 234);" class="token punctuation">(</span><span style="color: rgb(127, 219, 202);" class="token keyword">const</span><span class="token plain"> filePath </span><span style="color: rgb(127, 219, 202);" class="token keyword">of</span><span class="token plain"> </span><span style="color: rgb(130, 170, 255);" class="token function">getFiles</span><span style="color: rgb(199, 146, 234);" class="token punctuation">(</span><span class="token plain">dir</span><span style="color: rgb(199, 146, 234);" class="token punctuation">)</span><span style="color: rgb(199, 146, 234);" class="token punctuation">)</span><span class="token plain"> </span><span style="color: rgb(199, 146, 234);" class="token punctuation">{</span><span class="token plain"></span></div><div style="color: #d6deeb;" class="token-line"><span class="token plain">      </span><span style="color: rgb(127, 219, 202);" class="token keyword control-flow">if</span><span class="token plain"> </span><span style="color: rgb(199, 146, 234);" class="token punctuation">(</span><span class="token plain">filePath</span><span style="color: rgb(199, 146, 234);" class="token punctuation">.</span><span style="color: rgb(130, 170, 255);" class="token method function property-access">endsWith</span><span style="color: rgb(199, 146, 234);" class="token punctuation">(</span><span style="color: rgb(173, 219, 103);" class="token string">&quot;.js&quot;</span><span style="color: rgb(199, 146, 234);" class="token punctuation">)</span><span style="color: rgb(199, 146, 234);" class="token punctuation">)</span><span class="token plain"> </span><span style="color: rgb(199, 146, 234);" class="token punctuation">{</span><span class="token plain"></span></div><div style="color: #d6deeb;" class="token-line"><span class="token plain">        </span><span style="color: rgb(127, 219, 202);" class="token keyword">const</span><span class="token plain"> fileContents </span><span style="color: rgb(127, 219, 202);" class="token operator">=</span><span class="token plain"> </span><span style="color: rgb(127, 219, 202);" class="token keyword control-flow">await</span><span class="token plain"> fs</span><span style="color: rgb(199, 146, 234);" class="token punctuation">.</span><span style="color: rgb(130, 170, 255);" class="token method function property-access">readFile</span><span style="color: rgb(199, 146, 234);" class="token punctuation">(</span><span class="token plain">filePath</span><span style="color: rgb(199, 146, 234);" class="token punctuation">,</span><span class="token plain"> </span><span style="color: rgb(173, 219, 103);" class="token string">&quot;utf-8&quot;</span><span style="color: rgb(199, 146, 234);" class="token punctuation">)</span><span style="color: rgb(199, 146, 234);" class="token punctuation">;</span><span class="token plain"></span></div><div style="color: #d6deeb;" class="token-line"><span class="token plain">        </span><span style="color: rgb(127, 219, 202);" class="token keyword">const</span><span class="token plain"> transformed </span><span style="color: rgb(127, 219, 202);" class="token operator">=</span><span class="token plain"> </span><span style="color: rgb(127, 219, 202);" class="token keyword control-flow">await</span><span class="token plain"> service</span><span style="color: rgb(199, 146, 234);" class="token punctuation">.</span><span style="color: rgb(130, 170, 255);" class="token method function property-access">transform</span><span style="color: rgb(199, 146, 234);" class="token punctuation">(</span><span class="token plain">fileContents</span><span style="color: rgb(199, 146, 234);" class="token punctuation">,</span><span class="token plain"> options</span><span style="color: rgb(199, 146, 234);" class="token punctuation">)</span><span style="color: rgb(199, 146, 234);" class="token punctuation">;</span><span class="token plain"></span></div><div style="color: #d6deeb;" class="token-line"><span class="token plain">        </span><span style="color: rgb(127, 219, 202);" class="token keyword control-flow">await</span><span class="token plain"> fs</span><span style="color: rgb(199, 146, 234);" class="token punctuation">.</span><span style="color: rgb(130, 170, 255);" class="token method function property-access">writeFile</span><span style="color: rgb(199, 146, 234);" class="token punctuation">(</span><span class="token plain">filePath</span><span style="color: rgb(199, 146, 234);" class="token punctuation">,</span><span class="token plain"> transformed</span><span style="color: rgb(199, 146, 234);" class="token punctuation">.</span><span class="token property-access">code</span><span style="color: rgb(199, 146, 234);" class="token punctuation">)</span><span style="color: rgb(199, 146, 234);" class="token punctuation">;</span><span class="token plain"></span></div><div style="color: #d6deeb;" class="token-line"><span class="token plain">      </span><span style="color: rgb(199, 146, 234);" class="token punctuation">}</span><span class="token plain"></span></div><div style="color: #d6deeb;" class="token-line"><span class="token plain">    </span><span style="color: rgb(199, 146, 234);" class="token punctuation">}</span><span class="token plain"></span></div><div style="color: #d6deeb;" class="token-line"><span class="token plain">  </span><span style="color: rgb(199, 146, 234);" class="token punctuation">}</span><span class="token plain"> </span><span style="color: rgb(127, 219, 202);" class="token keyword control-flow">finally</span><span class="token plain"> </span><span style="color: rgb(199, 146, 234);" class="token punctuation">{</span><span class="token plain"></span></div><div style="color: #d6deeb;" class="token-line"><span class="token plain">    service</span><span style="color: rgb(199, 146, 234);" class="token punctuation">.</span><span style="color: rgb(130, 170, 255);" class="token method function property-access">stop</span><span style="color: rgb(199, 146, 234);" class="token punctuation">(</span><span style="color: rgb(199, 146, 234);" class="token punctuation">)</span><span style="color: rgb(199, 146, 234);" class="token punctuation">;</span><span class="token plain"></span></div><div style="color: #d6deeb;" class="token-line"><span class="token plain">  </span><span style="color: rgb(199, 146, 234);" class="token punctuation">}</span><span class="token plain"></span></div><div style="color: #d6deeb;" class="token-line"><span class="token plain"></span><span style="color: rgb(199, 146, 234);" class="token punctuation">}</span><span class="token plain"></span></div><div style="color: #d6deeb;" class="token-line"><span style="display: inline-block;" class="token plain">
</span></div><div style="color: #d6deeb;" class="token-line"><span class="token plain"></span><span style="color: rgb(127, 219, 202);" class="token keyword control-flow">await</span><span class="token plain"> </span><span style="color: rgb(130, 170, 255);" class="token function">main</span><span style="color: rgb(199, 146, 234);" class="token punctuation">(</span><span style="color: rgb(173, 219, 103);" class="token string">&quot;public/&quot;</span><span style="color: rgb(199, 146, 234);" class="token punctuation">)</span><span style="color: rgb(199, 146, 234);" class="token punctuation">;</span></div></pre></div><p>This uses <a href="https://esbuild.github.io/api/#js-specific-details">esbuild's Service API</a>, to start a long running esbuild server, then pushes files through to esbuild to be minified.</p><p>While reading the Service API docs again, I realised that we don't have to minify each file one-by-one. We can shove all the files through to esbuild and let it process them in parallel. Here's a second version that does that. It creates an array of promises, with each promise responsible for minifying one file.</p><div is="code" codestring="import esbuild from \&quot;esbuild\&quot;;\nimport fs from \&quot;fs/promises\&quot;;\n\nasync function* getFiles(path = `./`) {\n  const entries = await fs.readdir(path, { withFileTypes: true });\n\n  for (let file of entries) {\n    if (file.isDirectory()) {\n      yield* getFiles(`${path}${file.name}/`);\n    } else {\n      yield path + file.name;\n    }\n  }\n}\n\nconst minifyOptions = {\n  format: \&quot;esm\&quot;,\n  minify: true,\n  target: \&quot;es2020\&quot;,\n};\n\nasync function minifyFile(filePath, minifier) {\n  const fileContents = await fs.readFile(filePath, \&quot;utf-8\&quot;);\n  const transformed = await minifier.transform(fileContents, minifyOptions);\n  return await fs.writeFile(filePath, transformed.code);\n}\n\nasync function main(dir) {\n  let minifier = await esbuild.startService();\n  let promises = [];\n\n  try {\n    for await (const filePath of getFiles(dir)) {\n      if (filePath.endsWith(\&quot;.js\&quot;)) {\n        promises.push(minifyFile(filePath, minifier));\n      }\n    }\n\n    await Promise.all(promises);\n  } finally {\n    minifier.stop();\n  }\n}" class="language-js"><pre style="color: #d6deeb; background-color: transparent;" class="prism-code language-js"><div style="color: #d6deeb;" class="token-line"><span style="color: rgb(127, 219, 202);" class="token keyword module">import</span><span class="token plain"> </span><span class="token imports">esbuild</span><span class="token plain"> </span><span style="color: rgb(127, 219, 202);" class="token keyword module">from</span><span class="token plain"> </span><span style="color: rgb(173, 219, 103);" class="token string">&quot;esbuild&quot;</span><span style="color: rgb(199, 146, 234);" class="token punctuation">;</span><span class="token plain"></span></div><div style="color: #d6deeb;" class="token-line"><span class="token plain"></span><span style="color: rgb(127, 219, 202);" class="token keyword module">import</span><span class="token plain"> </span><span class="token imports">fs</span><span class="token plain"> </span><span style="color: rgb(127, 219, 202);" class="token keyword module">from</span><span class="token plain"> </span><span style="color: rgb(173, 219, 103);" class="token string">&quot;fs/promises&quot;</span><span style="color: rgb(199, 146, 234);" class="token punctuation">;</span><span class="token plain"></span></div><div style="color: #d6deeb;" class="token-line"><span style="display: inline-block;" class="token plain">
</span></div><div style="color: #d6deeb;" class="token-line"><span class="token plain"></span><span style="color: rgb(127, 219, 202);" class="token keyword">async</span><span class="token plain"> </span><span style="color: rgb(127, 219, 202);" class="token keyword">function</span><span style="color: rgb(127, 219, 202);" class="token operator">*</span><span class="token plain"> </span><span style="color: rgb(130, 170, 255);" class="token function">getFiles</span><span style="color: rgb(199, 146, 234);" class="token punctuation">(</span><span class="token plain">path </span><span style="color: rgb(127, 219, 202);" class="token operator">=</span><span class="token plain"> </span><span style="color: rgb(173, 219, 103);" class="token template-string template-punctuation string">`</span><span style="color: rgb(173, 219, 103);" class="token template-string string">./</span><span style="color: rgb(173, 219, 103);" class="token template-string template-punctuation string">`</span><span style="color: rgb(199, 146, 234);" class="token punctuation">)</span><span class="token plain"> </span><span style="color: rgb(199, 146, 234);" class="token punctuation">{</span><span class="token plain"></span></div><div style="color: #d6deeb;" class="token-line"><span class="token plain">  </span><span style="color: rgb(127, 219, 202);" class="token keyword">const</span><span class="token plain"> entries </span><span style="color: rgb(127, 219, 202);" class="token operator">=</span><span class="token plain"> </span><span style="color: rgb(127, 219, 202);" class="token keyword control-flow">await</span><span class="token plain"> fs</span><span style="color: rgb(199, 146, 234);" class="token punctuation">.</span><span style="color: rgb(130, 170, 255);" class="token method function property-access">readdir</span><span style="color: rgb(199, 146, 234);" class="token punctuation">(</span><span class="token plain">path</span><span style="color: rgb(199, 146, 234);" class="token punctuation">,</span><span class="token plain"> </span><span style="color: rgb(199, 146, 234);" class="token punctuation">{</span><span class="token plain"> withFileTypes</span><span style="color: rgb(127, 219, 202);" class="token operator">:</span><span class="token plain"> </span><span style="color: rgb(255, 88, 116);" class="token boolean">true</span><span class="token plain"> </span><span style="color: rgb(199, 146, 234);" class="token punctuation">}</span><span style="color: rgb(199, 146, 234);" class="token punctuation">)</span><span style="color: rgb(199, 146, 234);" class="token punctuation">;</span><span class="token plain"></span></div><div style="color: #d6deeb;" class="token-line"><span style="display: inline-block;" class="token plain">
</span></div><div style="color: #d6deeb;" class="token-line"><span class="token plain">  </span><span style="color: rgb(127, 219, 202);" class="token keyword control-flow">for</span><span class="token plain"> </span><span style="color: rgb(199, 146, 234);" class="token punctuation">(</span><span style="color: rgb(127, 219, 202);" class="token keyword">let</span><span class="token plain"> file </span><span style="color: rgb(127, 219, 202);" class="token keyword">of</span><span class="token plain"> entries</span><span style="color: rgb(199, 146, 234);" class="token punctuation">)</span><span class="token plain"> </span><span style="color: rgb(199, 146, 234);" class="token punctuation">{</span><span class="token plain"></span></div><div style="color: #d6deeb;" class="token-line"><span class="token plain">    </span><span style="color: rgb(127, 219, 202);" class="token keyword control-flow">if</span><span class="token plain"> </span><span style="color: rgb(199, 146, 234);" class="token punctuation">(</span><span class="token plain">file</span><span style="color: rgb(199, 146, 234);" class="token punctuation">.</span><span style="color: rgb(130, 170, 255);" class="token method function property-access">isDirectory</span><span style="color: rgb(199, 146, 234);" class="token punctuation">(</span><span style="color: rgb(199, 146, 234);" class="token punctuation">)</span><span style="color: rgb(199, 146, 234);" class="token punctuation">)</span><span class="token plain"> </span><span style="color: rgb(199, 146, 234);" class="token punctuation">{</span><span class="token plain"></span></div><div style="color: #d6deeb;" class="token-line"><span class="token plain">      </span><span style="color: rgb(127, 219, 202);" class="token keyword control-flow">yield</span><span style="color: rgb(127, 219, 202);" class="token operator">*</span><span class="token plain"> </span><span style="color: rgb(130, 170, 255);" class="token function">getFiles</span><span style="color: rgb(199, 146, 234);" class="token punctuation">(</span><span style="color: rgb(173, 219, 103);" class="token template-string template-punctuation string">`</span><span style="color: rgb(199, 146, 234);" class="token template-string interpolation interpolation-punctuation punctuation">${</span><span class="token template-string interpolation">path</span><span style="color: rgb(199, 146, 234);" class="token template-string interpolation interpolation-punctuation punctuation">}</span><span style="color: rgb(199, 146, 234);" class="token template-string interpolation interpolation-punctuation punctuation">${</span><span class="token template-string interpolation">file</span><span style="color: rgb(199, 146, 234);" class="token template-string interpolation punctuation">.</span><span class="token template-string interpolation property-access">name</span><span style="color: rgb(199, 146, 234);" class="token template-string interpolation interpolation-punctuation punctuation">}</span><span style="color: rgb(173, 219, 103);" class="token template-string string">/</span><span style="color: rgb(173, 219, 103);" class="token template-string template-punctuation string">`</span><span style="color: rgb(199, 146, 234);" class="token punctuation">)</span><span style="color: rgb(199, 146, 234);" class="token punctuation">;</span><span class="token plain"></span></div><div style="color: #d6deeb;" class="token-line"><span class="token plain">    </span><span style="color: rgb(199, 146, 234);" class="token punctuation">}</span><span class="token plain"> </span><span style="color: rgb(127, 219, 202);" class="token keyword control-flow">else</span><span class="token plain"> </span><span style="color: rgb(199, 146, 234);" class="token punctuation">{</span><span class="token plain"></span></div><div style="color: #d6deeb;" class="token-line"><span class="token plain">      </span><span style="color: rgb(127, 219, 202);" class="token keyword control-flow">yield</span><span class="token plain"> path </span><span style="color: rgb(127, 219, 202);" class="token operator">+</span><span class="token plain"> file</span><span style="color: rgb(199, 146, 234);" class="token punctuation">.</span><span class="token property-access">name</span><span style="color: rgb(199, 146, 234);" class="token punctuation">;</span><span class="token plain"></span></div><div style="color: #d6deeb;" class="token-line"><span class="token plain">    </span><span style="color: rgb(199, 146, 234);" class="token punctuation">}</span><span class="token plain"></span></div><div style="color: #d6deeb;" class="token-line"><span class="token plain">  </span><span style="color: rgb(199, 146, 234);" class="token punctuation">}</span><span class="token plain"></span></div><div style="color: #d6deeb;" class="token-line"><span class="token plain"></span><span style="color: rgb(199, 146, 234);" class="token punctuation">}</span><span class="token plain"></span></div><div style="color: #d6deeb;" class="token-line"><span style="display: inline-block;" class="token plain">
</span></div><div style="color: #d6deeb;" class="token-line"><span class="token plain"></span><span style="color: rgb(127, 219, 202);" class="token keyword">const</span><span class="token plain"> minifyOptions </span><span style="color: rgb(127, 219, 202);" class="token operator">=</span><span class="token plain"> </span><span style="color: rgb(199, 146, 234);" class="token punctuation">{</span><span class="token plain"></span></div><div style="color: #d6deeb;" class="token-line"><span class="token plain">  format</span><span style="color: rgb(127, 219, 202);" class="token operator">:</span><span class="token plain"> </span><span style="color: rgb(173, 219, 103);" class="token string">&quot;esm&quot;</span><span style="color: rgb(199, 146, 234);" class="token punctuation">,</span><span class="token plain"></span></div><div style="color: #d6deeb;" class="token-line"><span class="token plain">  minify</span><span style="color: rgb(127, 219, 202);" class="token operator">:</span><span class="token plain"> </span><span style="color: rgb(255, 88, 116);" class="token boolean">true</span><span style="color: rgb(199, 146, 234);" class="token punctuation">,</span><span class="token plain"></span></div><div style="color: #d6deeb;" class="token-line"><span class="token plain">  target</span><span style="color: rgb(127, 219, 202);" class="token operator">:</span><span class="token plain"> </span><span style="color: rgb(173, 219, 103);" class="token string">&quot;es2020&quot;</span><span style="color: rgb(199, 146, 234);" class="token punctuation">,</span><span class="token plain"></span></div><div style="color: #d6deeb;" class="token-line"><span class="token plain"></span><span style="color: rgb(199, 146, 234);" class="token punctuation">}</span><span style="color: rgb(199, 146, 234);" class="token punctuation">;</span><span class="token plain"></span></div><div style="color: #d6deeb;" class="token-line"><span style="display: inline-block;" class="token plain">
</span></div><div style="color: #d6deeb;" class="token-line"><span class="token plain"></span><span style="color: rgb(127, 219, 202);" class="token keyword">async</span><span class="token plain"> </span><span style="color: rgb(127, 219, 202);" class="token keyword">function</span><span class="token plain"> </span><span style="color: rgb(130, 170, 255);" class="token function">minifyFile</span><span style="color: rgb(199, 146, 234);" class="token punctuation">(</span><span class="token parameter">filePath</span><span style="color: rgb(199, 146, 234);" class="token parameter punctuation">,</span><span class="token parameter"> minifier</span><span style="color: rgb(199, 146, 234);" class="token punctuation">)</span><span class="token plain"> </span><span style="color: rgb(199, 146, 234);" class="token punctuation">{</span><span class="token plain"></span></div><div style="color: #d6deeb;" class="token-line"><span class="token plain">  </span><span style="color: rgb(127, 219, 202);" class="token keyword">const</span><span class="token plain"> fileContents </span><span style="color: rgb(127, 219, 202);" class="token operator">=</span><span class="token plain"> </span><span style="color: rgb(127, 219, 202);" class="token keyword control-flow">await</span><span class="token plain"> fs</span><span style="color: rgb(199, 146, 234);" class="token punctuation">.</span><span style="color: rgb(130, 170, 255);" class="token method function property-access">readFile</span><span style="color: rgb(199, 146, 234);" class="token punctuation">(</span><span class="token plain">filePath</span><span style="color: rgb(199, 146, 234);" class="token punctuation">,</span><span class="token plain"> </span><span style="color: rgb(173, 219, 103);" class="token string">&quot;utf-8&quot;</span><span style="color: rgb(199, 146, 234);" class="token punctuation">)</span><span style="color: rgb(199, 146, 234);" class="token punctuation">;</span><span class="token plain"></span></div><div style="color: #d6deeb;" class="token-line"><span class="token plain">  </span><span style="color: rgb(127, 219, 202);" class="token keyword">const</span><span class="token plain"> transformed </span><span style="color: rgb(127, 219, 202);" class="token operator">=</span><span class="token plain"> </span><span style="color: rgb(127, 219, 202);" class="token keyword control-flow">await</span><span class="token plain"> minifier</span><span style="color: rgb(199, 146, 234);" class="token punctuation">.</span><span style="color: rgb(130, 170, 255);" class="token method function property-access">transform</span><span style="color: rgb(199, 146, 234);" class="token punctuation">(</span><span class="token plain">fileContents</span><span style="color: rgb(199, 146, 234);" class="token punctuation">,</span><span class="token plain"> minifyOptions</span><span style="color: rgb(199, 146, 234);" class="token punctuation">)</span><span style="color: rgb(199, 146, 234);" class="token punctuation">;</span><span class="token plain"></span></div><div style="color: #d6deeb;" class="token-line"><span class="token plain">  </span><span style="color: rgb(127, 219, 202);" class="token keyword control-flow">return</span><span class="token plain"> </span><span style="color: rgb(127, 219, 202);" class="token keyword control-flow">await</span><span class="token plain"> fs</span><span style="color: rgb(199, 146, 234);" class="token punctuation">.</span><span style="color: rgb(130, 170, 255);" class="token method function property-access">writeFile</span><span style="color: rgb(199, 146, 234);" class="token punctuation">(</span><span class="token plain">filePath</span><span style="color: rgb(199, 146, 234);" class="token punctuation">,</span><span class="token plain"> transformed</span><span style="color: rgb(199, 146, 234);" class="token punctuation">.</span><span class="token property-access">code</span><span style="color: rgb(199, 146, 234);" class="token punctuation">)</span><span style="color: rgb(199, 146, 234);" class="token punctuation">;</span><span class="token plain"></span></div><div style="color: #d6deeb;" class="token-line"><span class="token plain"></span><span style="color: rgb(199, 146, 234);" class="token punctuation">}</span><span class="token plain"></span></div><div style="color: #d6deeb;" class="token-line"><span style="display: inline-block;" class="token plain">
</span></div><div style="color: #d6deeb;" class="token-line"><span class="token plain"></span><span style="color: rgb(127, 219, 202);" class="token keyword">async</span><span class="token plain"> </span><span style="color: rgb(127, 219, 202);" class="token keyword">function</span><span class="token plain"> </span><span style="color: rgb(130, 170, 255);" class="token function">main</span><span style="color: rgb(199, 146, 234);" class="token punctuation">(</span><span class="token parameter">dir</span><span style="color: rgb(199, 146, 234);" class="token punctuation">)</span><span class="token plain"> </span><span style="color: rgb(199, 146, 234);" class="token punctuation">{</span><span class="token plain"></span></div><div style="color: #d6deeb;" class="token-line"><span class="token plain">  </span><span style="color: rgb(127, 219, 202);" class="token keyword">let</span><span class="token plain"> minifier </span><span style="color: rgb(127, 219, 202);" class="token operator">=</span><span class="token plain"> </span><span style="color: rgb(127, 219, 202);" class="token keyword control-flow">await</span><span class="token plain"> esbuild</span><span style="color: rgb(199, 146, 234);" class="token punctuation">.</span><span style="color: rgb(130, 170, 255);" class="token method function property-access">startService</span><span style="color: rgb(199, 146, 234);" class="token punctuation">(</span><span style="color: rgb(199, 146, 234);" class="token punctuation">)</span><span style="color: rgb(199, 146, 234);" class="token punctuation">;</span><span class="token plain"></span></div><div style="color: #d6deeb;" class="token-line"><span class="token plain">  </span><span style="color: rgb(127, 219, 202);" class="token keyword">let</span><span class="token plain"> promises </span><span style="color: rgb(127, 219, 202);" class="token operator">=</span><span class="token plain"> </span><span style="color: rgb(199, 146, 234);" class="token punctuation">[</span><span style="color: rgb(199, 146, 234);" class="token punctuation">]</span><span style="color: rgb(199, 146, 234);" class="token punctuation">;</span><span class="token plain"></span></div><div style="color: #d6deeb;" class="token-line"><span style="display: inline-block;" class="token plain">
</span></div><div style="color: #d6deeb;" class="token-line"><span class="token plain">  </span><span style="color: rgb(127, 219, 202);" class="token keyword control-flow">try</span><span class="token plain"> </span><span style="color: rgb(199, 146, 234);" class="token punctuation">{</span><span class="token plain"></span></div><div style="color: #d6deeb;" class="token-line"><span class="token plain">    </span><span style="color: rgb(127, 219, 202);" class="token keyword control-flow">for</span><span class="token plain"> </span><span style="color: rgb(127, 219, 202);" class="token keyword control-flow">await</span><span class="token plain"> </span><span style="color: rgb(199, 146, 234);" class="token punctuation">(</span><span style="color: rgb(127, 219, 202);" class="token keyword">const</span><span class="token plain"> filePath </span><span style="color: rgb(127, 219, 202);" class="token keyword">of</span><span class="token plain"> </span><span style="color: rgb(130, 170, 255);" class="token function">getFiles</span><span style="color: rgb(199, 146, 234);" class="token punctuation">(</span><span class="token plain">dir</span><span style="color: rgb(199, 146, 234);" class="token punctuation">)</span><span style="color: rgb(199, 146, 234);" class="token punctuation">)</span><span class="token plain"> </span><span style="color: rgb(199, 146, 234);" class="token punctuation">{</span><span class="token plain"></span></div><div style="color: #d6deeb;" class="token-line"><span class="token plain">      </span><span style="color: rgb(127, 219, 202);" class="token keyword control-flow">if</span><span class="token plain"> </span><span style="color: rgb(199, 146, 234);" class="token punctuation">(</span><span class="token plain">filePath</span><span style="color: rgb(199, 146, 234);" class="token punctuation">.</span><span style="color: rgb(130, 170, 255);" class="token method function property-access">endsWith</span><span style="color: rgb(199, 146, 234);" class="token punctuation">(</span><span style="color: rgb(173, 219, 103);" class="token string">&quot;.js&quot;</span><span style="color: rgb(199, 146, 234);" class="token punctuation">)</span><span style="color: rgb(199, 146, 234);" class="token punctuation">)</span><span class="token plain"> </span><span style="color: rgb(199, 146, 234);" class="token punctuation">{</span><span class="token plain"></span></div><div style="color: #d6deeb;" class="token-line"><span class="token plain">        promises</span><span style="color: rgb(199, 146, 234);" class="token punctuation">.</span><span style="color: rgb(130, 170, 255);" class="token method function property-access">push</span><span style="color: rgb(199, 146, 234);" class="token punctuation">(</span><span style="color: rgb(130, 170, 255);" class="token function">minifyFile</span><span style="color: rgb(199, 146, 234);" class="token punctuation">(</span><span class="token plain">filePath</span><span style="color: rgb(199, 146, 234);" class="token punctuation">,</span><span class="token plain"> minifier</span><span style="color: rgb(199, 146, 234);" class="token punctuation">)</span><span style="color: rgb(199, 146, 234);" class="token punctuation">)</span><span style="color: rgb(199, 146, 234);" class="token punctuation">;</span><span class="token plain"></span></div><div style="color: #d6deeb;" class="token-line"><span class="token plain">      </span><span style="color: rgb(199, 146, 234);" class="token punctuation">}</span><span class="token plain"></span></div><div style="color: #d6deeb;" class="token-line"><span class="token plain">    </span><span style="color: rgb(199, 146, 234);" class="token punctuation">}</span><span class="token plain"></span></div><div style="color: #d6deeb;" class="token-line"><span style="display: inline-block;" class="token plain">
</span></div><div style="color: #d6deeb;" class="token-line"><span class="token plain">    </span><span style="color: rgb(127, 219, 202);" class="token keyword control-flow">await</span><span class="token plain"> </span><span style="color: rgb(255, 203, 139);" class="token known-class-name class-name">Promise</span><span style="color: rgb(199, 146, 234);" class="token punctuation">.</span><span style="color: rgb(130, 170, 255);" class="token method function property-access">all</span><span style="color: rgb(199, 146, 234);" class="token punctuation">(</span><span class="token plain">promises</span><span style="color: rgb(199, 146, 234);" class="token punctuation">)</span><span style="color: rgb(199, 146, 234);" class="token punctuation">;</span><span class="token plain"></span></div><div style="color: #d6deeb;" class="token-line"><span class="token plain">  </span><span style="color: rgb(199, 146, 234);" class="token punctuation">}</span><span class="token plain"> </span><span style="color: rgb(127, 219, 202);" class="token keyword control-flow">finally</span><span class="token plain"> </span><span style="color: rgb(199, 146, 234);" class="token punctuation">{</span><span class="token plain"></span></div><div style="color: #d6deeb;" class="token-line"><span class="token plain">    minifier</span><span style="color: rgb(199, 146, 234);" class="token punctuation">.</span><span style="color: rgb(130, 170, 255);" class="token method function property-access">stop</span><span style="color: rgb(199, 146, 234);" class="token punctuation">(</span><span style="color: rgb(199, 146, 234);" class="token punctuation">)</span><span style="color: rgb(199, 146, 234);" class="token punctuation">;</span><span class="token plain"></span></div><div style="color: #d6deeb;" class="token-line"><span class="token plain">  </span><span style="color: rgb(199, 146, 234);" class="token punctuation">}</span><span class="token plain"></span></div><div style="color: #d6deeb;" class="token-line"><span class="token plain"></span><span style="color: rgb(199, 146, 234);" class="token punctuation">}</span></div></pre></div><p>On my machine this minified ten files in ~22 milliseconds, vs ~35 milliseconds for the first version.</p><p>I'd have to run this script millions of times to see any benefit from this optimisation. But at least I can confidently state my official conclusion: esbuild is pretty neat.</p><h2 id="minifying-other-file-types" is="postHeading"><a href="#minifying-other-file-types">Minifying other file types</a></h2><p><code>esbuild</code> has bundling support for CSS. I haven't (yet) tested whether I can use it to <em>minify</em> CSS. Maybe it will handle JSON too?</p></article></main><footer is="mainFooter"><a href="https://github.com/m-allanson/mikeallanson.com">Source available on GitHub</a></footer></div>
    <script type="module">
    /* @jsx jsx */

async function renderPage() {
  const promises = [
    import(window.componentPath),
    window.wrapperComponentPath
      ? import(window.wrapperComponentPath)
      : undefined,
    window.dataPath
      ? fetch(window.dataPath).then(response => {
          return response.json();
        })
      : {},
    import("/web_modules/preact.js")
  ];

  let pageWrapper = ({ children }) => h("div", null, children);
  const [
    PageModule,
    PageWrapperModule,
    pageData,
    { render, h }
  ] = await Promise.all(promises);
  const Page = PageModule.default;
  if(PageWrapperModule) {
    pageWrapper = PageWrapperModule.default
  }

  render(
    h(pageWrapper, pageData, h(Page, pageData)),
    document.getElementById("toast-page-section")
  );
}

renderPage();

</script>
  </body>
</html>
